@using SharpIDE.Application.Features.SolutionDiscovery
@using SharpIDE.Application.Features.SolutionDiscovery.VsPersistence

@if (SolutionModel is null)
{
	return;
}
<MudTreeView T="SharpIdeSolutionModel" Dense="true">
	<MudTreeViewItem TextTypo="Typo.body2" Expanded="true" Icon="@Icons.Material.Filled.Folder" IconColor="Color.Primary" Value="@SolutionModel" Text="@SolutionModel.Name">
		<MudTreeView Dense="true">
			@foreach (var folder in SolutionModel.Folders)
			{
				@GetSolutionFolderFragment(folder)
			}
			@foreach(var project in SolutionModel.Projects)
			{
				@GetProjectFragment(project)
			}
		</MudTreeView>
	</MudTreeViewItem>
</MudTreeView>


@code {
	[Parameter, EditorRequired]
    public string SolutionFilePath { get; set; } = null!;

	[Parameter, EditorRequired]
	public SharpIdeSolutionModel SolutionModel { get; set; } = null!;

	[Parameter, EditorRequired]
	public SharpIdeFile SelectedFile { get; set; } = null!;

	[Parameter]
	public EventCallback<SharpIdeFile> SelectedFileChanged { get; set; }

	private async Task InvokeSelectedFileChanged(SharpIdeFile file)
	{
		SelectedFile = file;
		await SelectedFileChanged.InvokeAsync(file);
	}

	private RenderFragment GetSolutionFolderFragment(SharpIdeSolutionFolder slnFolder) =>
		@<text>
			 <MudTreeViewItem TextTypo="Typo.body2" Icon="@Icons.Material.Filled.Folder" IconColor="Color.Primary" Value="@slnFolder" Text="@slnFolder.Name">
				 @foreach(var childFolder in slnFolder.Folders)
				 {
					 @GetSolutionFolderFragment(childFolder)
				 }
				 @foreach(var childProject in slnFolder.Projects)
				 {
					 @GetProjectFragment(childProject)
				 }
			 </MudTreeViewItem>
		</text>;

	private RenderFragment GetProjectFragment(SharpIdeProjectModel project) =>
		@<text>
			 <MudTreeViewItem TextTypo="Typo.body2" Icon="@Icons.Custom.FileFormats.FileCode" IconColor="Color.Success" Text="@project.Name" Value="project">
				 @foreach (var folder in project.Folders)
				 {
					 <MudTreeViewItem TextTypo="Typo.body2" Icon="@Icons.Material.Filled.Folder" IconColor="Color.Default" @bind-Expanded="folder.Expanded" Text="@folder.Name" Value="@folder">
						 @GetFolderFragment(folder)
					 </MudTreeViewItem>
				 }
				 @foreach(var file in project.Files)
				 {
					 @GetFileFragment(file)
				 }
			 </MudTreeViewItem>
		</text>;

	private RenderFragment GetFolderFragment(SharpIdeFolder folder) =>
		@<text>
				 @foreach (var subFolder in folder.Folders)
				 {
					 <MudTreeViewItem TextTypo="Typo.body2" Icon="@Icons.Material.Filled.Folder" IconColor="Color.Default" @bind-Expanded="subFolder.Expanded" Text="@subFolder.Name" Value="@subFolder">
						 @if (subFolder.Expanded)
						 {
							 @GetFolderFragment(subFolder)
						 }
					 </MudTreeViewItem>
				 }
				 @foreach (var file in folder.Files)
				 {
					 @GetFileFragment(file)
				 }
		</text>;

	private RenderFragment GetFileFragment(SharpIdeFile file) =>
		@<text>
			 <MudTreeViewItem T="SharpIdeFile" Icon="@Icons.Custom.FileFormats.FileCode" TextTypo="Typo.body2" Text="@file.Name" Value="@file" OnClick="@(async () => await InvokeSelectedFileChanged(file))"/>
		</text>;


}
